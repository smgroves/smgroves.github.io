<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Single Cell Analysis | Sarah M. Groves</title> <meta name="author" content="Sarah M. Groves"/> <meta name="description" content="I was a Guest Lecturer for this course at Vanderbilt University. Click here to see the RNA Velocity Tutorial I taught."/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/favicon-32x32.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://smgroves.github.io/courses/2019_spring_single_cell/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <title>Single Cell Analysis | blank</title> <meta name="generator" content="Jekyll v4.4.1"/> <meta property="og:title" content="Single Cell Analysis"/> <meta property="og:locale" content="en"/> <meta name="description" content="I was a Guest Lecturer for this course at Vanderbilt University. Click here to see the RNA Velocity Tutorial I taught."/> <meta property="og:description" content="I was a Guest Lecturer for this course at Vanderbilt University. Click here to see the RNA Velocity Tutorial I taught."/> <link rel="canonical" href="https://smgroves.github.io/courses/2019_spring_single_cell/"/> <meta property="og:url" content="https://smgroves.github.io/courses/2019_spring_single_cell/"/> <meta property="og:site_name" content="blank"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2026-02-13T02:52:28+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Single Cell Analysis"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2026-02-13T02:52:28+00:00","datePublished":"2026-02-13T02:52:28+00:00","description":"I was a Guest Lecturer for this course at Vanderbilt University. Click here to see the RNA Velocity Tutorial I taught.","headline":"Single Cell Analysis","mainEntityOfPage":{"@type":"WebPage","@id":"https://smgroves.github.io/courses/2019_spring_single_cell/"},"url":"https://smgroves.github.io/courses/2019_spring_single_cell/"}</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Sarah </span>M. Groves</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">scicomm</a> </li> <li class="nav-item "> <a class="nav-link" href="/notebooks/">notebooks</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/courses/">courses</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Single Cell Analysis</h1> <p class="post-description">I was a Guest Lecturer for this course at Vanderbilt University. Click here to see the RNA Velocity Tutorial I taught.</p> </header> <article> <p>For my guest lecture, I taught the students how to use an RNA velocity package called <code class="language-plaintext highlighter-rouge">velocyto</code>, based on <a href="https://pubmed.ncbi.nlm.nih.gov/30089906/" target="_blank" rel="noopener noreferrer">La Manno et al. (2018)</a>. I was asked to give the same lecture the following year. The notebook I used for the presentation and gave to the students is shown below, which provides an overview of RNA velocity analysis on a tumor dataset.</p> <h1 id="rna-velocity">RNA Velocity</h1> <p>This notebook is an introduction to RNA velocity using the Python package <code class="language-plaintext highlighter-rouge">velocyto</code>. The code below is run on a dataset of Small Cell Lung Cancer mouse tumor cells, originally published in Wooten et al., 2019 (TKO1). The data was deposited in GEO under accession number GSE137749, and a loom file can be generated as described below (with <code class="language-plaintext highlighter-rouge">velocyto</code>’s command line interface).</p> <h2 id="background-on-rna-velocity">Background on RNA Velocity</h2> <div class="img"> <img src="/assets/img/rna-velocity/background.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="caption"> La Manno et al., 2018. </div> <ul> <li>A. Both read-based and UMI based techniques can be used to align unspliced and spliced reads. Usually % unspliced reads is around 15% to 20% (higher than expected in inDrop and other 3’-end based protocols because of internal splicing).</li> <li>B. Simple model used to calculate velocity. \(\alpha\) can be difficult to fit (rate of transcription), so other assumptions are necessary in order to solve the set of differential equations (constant velocity or constant unspliced counts per gene). \(\beta\) is set to one, so the units of time are in terms of the splicing rate. Most of the velocyto pipeline to calculate velocity involves fitting \(\gamma\), the degradation rate.</li> <li>C. Because of the time lag in splicing, a transcription rate increase will increase unspliced RNA faster than spliced RNA. This lag is also shown in E, where unspliced RNA from one timepoint can predict spliced RNA 3 hours later for circadian genes.</li> <li>D. If velocity = 0, then \(u = \gamma s\). Once we fit gamma for each gene, we can simply compare the unspliced and spliced counts for each gene for each cell to determine velocity. If \(u &gt; \gamma s\), the velocity is positive (spliced reads will increase); likely, if less than, the velocity is negative. This is calculated for each gene for each cell.</li> <li>E. Example using circadian genes. This is a proof of principle, that we can predict future expression of RNA based on this model. Prediction is for a time step of approximately 3-4 hours, and trajectory analysis through the landscape based on velocity can extrapolate farther into the future. However, this assumes that there are no hidden variables in the model, and therefore <strong>cell trajectories are Markovian, and any form of cellular memory is encoded <em>only</em> in their measured RNA expression.</strong> In other words, a specific location in phenotypic space (i.e. a gene expression vector) has one defined velocity, and the properties of the cell available for measurement fully encode a probability distribution over its possible future states. Keep in mind that any trajectory analysis (graph-based or otherwise) that only considers RNA expression is also making this assumption.</li> <li>F. and G. Examples of two circadian genes over a 24 hour time course. Any circadian (cyclic) pattern of gene expression will be a loop in this space.</li> <li>H. Observed state versus extrapolated state based on RNA velocity in a PCA. Most of the plots we will look at will be like this: actually cells in PCA (or other dimensionality-reduced) space with arrows suggesting their extrapolated state. Importantly, to visualize these arrows (which may not actually align with the dimensionality reduction/transformation), we must <em>embed</em> the velocity arrows into that space as well. This allows us to predict <em>both</em> the future state of each cell (which does not need embedding) <em>and</em> the transition probabilities to other cell states in the landscape (which requires embedding).</li> </ul> <h2 id="creation-of-loom-file">Creation of loom file</h2> <p>First step in the velocyto pipeline is to generate a loom file that has both unspliced and spliced count matrices. More information on loom files: http://loompy.org/ However, velocyto has its own version of loom files, so some functions will be different. For example, we will read in a new loom file with the call: <code class="language-plaintext highlighter-rouge">velocyto.VelocytoLoom('loom_file.loom')</code>. I will assume we already have this loom file, generated by: http://velocyto.org/velocyto.py/tutorial/cli.html</p> <div class="img"> <img src="/assets/img/rna-velocity/Loom_components.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="caption"> Loom file structure. </div> <h2 id="import-packages">Import packages</h2> <p>You must have downloaded: <code class="language-plaintext highlighter-rouge">velocyto</code>, <code class="language-plaintext highlighter-rouge">MulticoreTSNE</code>, <code class="language-plaintext highlighter-rouge">bbknn</code> and <code class="language-plaintext highlighter-rouge">loompy</code>. The other packages below are fairly common.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">scanpy.api</span> <span class="k">as</span> <span class="n">sc</span>
<span class="kn">from</span> <span class="n">MulticoreTSNE</span> <span class="kn">import</span> <span class="n">MulticoreTSNE</span> <span class="k">as</span> <span class="n">TSNE</span>
<span class="kn">import</span> <span class="n">os.path</span> <span class="k">as</span> <span class="n">op</span>
<span class="kn">import</span> <span class="n">scanpy.external</span> <span class="k">as</span> <span class="n">sce</span>
<span class="kn">import</span> <span class="n">bbknn</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">matplotlib</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">loompy</span>
<span class="kn">import</span> <span class="n">velocyto</span> <span class="k">as</span> <span class="n">vcy</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="n">sklearn.neighbors.kde</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">sc</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># verbosity: errors (0), warnings (1), info (2), hints (3)
</span><span class="n">sc</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="nf">set_figure_params</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>  <span class="c1"># low dpi (dots per inch) yields small inline figures
</span><span class="n">sc</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="nf">print_version_and_date</span><span class="p">()</span>
<span class="c1"># we will soon provide an update with more recent dependencies
</span><span class="n">sc</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="nf">print_versions_dependencies_numerics</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running Scanpy 1.4 on 2019-03-18 10:03.
Dependencies: anndata==0.6.18 numpy==1.16.2 scipy==1.2.0 pandas==0.24.1 scikit-learn==0.20.2 statsmodels==0.9.0 python-igraph==0.7.1 louvain==0.6.1 
</code></pre></div></div> <h2 id="load-loom-file-and-preprocess-spliced-and-unspliced-count-matrices">Load loom file and preprocess spliced and unspliced count matrices</h2> <p>Code adapted from https://github.com/velocyto-team/velocyto-notebooks/blob/master/python/hgForebrainGlutamatergic.ipynb</p> <p>You should be able to use an alternative preprocessing pipeline for the S matrix to filter cells and normalize. Then use the cell IDs to tranfer the preprocessing information into the loom file. I would be careful though with the U matrix, because all of the counts will be lower in general than S and you don’t necessarily want to filter out low counts. Velocyto has a method to filter U based on detection levels which is used below (min_expr_counts_U = 0).</p> <p>In velocyto, you must first score the cells/genes and <em>then</em> actually filter them out with a different command, so make sure to include both when filtering.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Replace with your loom file
</span>
<span class="n">vlm</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="nc">VelocytoLoom</span><span class="p">(</span><span class="sh">'</span><span class="s">/Users/sarahmaddox/Quaranta_Lab/SCLC/scRNAseq/velocyto_loom/TK01.loom</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div> <p>Below, I chose to plot the cv vs mean plot but did not filter on this criteria, because I wanted to be more conservative with the number of genes filtered out.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="sh">"</span><span class="s">S</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="sh">"</span><span class="s">U</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">vlm</span><span class="p">.</span><span class="nf">score_detection_levels</span><span class="p">(</span><span class="n">min_expr_counts</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_cells_express</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                           <span class="n">min_expr_counts_U</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_cells_express_U</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">filter_genes</span><span class="p">(</span><span class="n">by_detection_levels</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">vlm</span><span class="p">.</span><span class="nf">score_cv_vs_mean</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_expr_avg</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">winsorize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">winsor_perc</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">99.8</span><span class="p">),</span> <span class="n">svr_gamma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_expr_cells</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="c1"># vlm.filter_genes(by_cv_vs_mean=True)
</span></code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_11_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <p>Also normalize the cells using the (initial) total molecules as size estimate and then adjust the spliced count on the base of the relation S_sz_tot and U_sz_tot</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">score_detection_levels</span><span class="p">(</span><span class="n">min_expr_counts</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_cells_express</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">min_expr_counts_U</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">min_cells_express_U</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">normalize_by_total</span><span class="p">(</span><span class="n">min_perc_U</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">adjust_totS_totU</span><span class="p">(</span><span class="n">normalize_total</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fit_with_low_U</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">svr_C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">svr_gamma</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">)</span>
</code></pre></div></div> <h2 id="run-pca">Run PCA</h2> <p>This must be done before the kNN imputation because the PCA dimensionality reduction is used to impute the nearest neighbors. Also I am plotting the cumulative sum of the explained variance ratio for the first 100 PCs. This is to help determine how many PCs to use for future analyses. Keep in mind that you can run other dimensionality reduction techniques, but I am choosing to plot everything using PCA.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">perform_PCA</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">cumsum</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">explained_variance_ratio_</span><span class="p">)[:</span><span class="mi">100</span><span class="p">])</span>
<span class="n">n_comps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">cumsum</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">explained_variance_ratio_</span><span class="p">))</span><span class="o">&gt;</span><span class="mf">0.002</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">vlm</span><span class="p">.</span><span class="n">pcs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span> 
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_15_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">plot_fractions</span><span class="p">()</span>
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_16_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h1 id="cluster-cells-in-pca-or-other-dimensionality-reduction">Cluster cells in PCA (or other dimensionality reduction)</h1> <p>Below code: R Function Princurve is implemented in python through rpy2</p> <p>This is used to draw a principle curve through the graph based on the first few PC dimensions. Unnecessary for pipline but may help explain the data if there is a clear path through it.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Wrap implementation
</span><span class="kn">import</span> <span class="n">rpy2.robjects</span> <span class="k">as</span> <span class="n">robj</span>
<span class="kn">from</span> <span class="n">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>

<span class="k">def</span> <span class="nf">array_to_rmatrix</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span>
    <span class="n">xvec</span> <span class="o">=</span> <span class="n">robj</span><span class="p">.</span><span class="nc">FloatVector</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="nf">transpose</span><span class="p">().</span><span class="nf">reshape</span><span class="p">((</span><span class="n">X</span><span class="p">.</span><span class="n">size</span><span class="p">)))</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="n">robj</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="nf">matrix</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xr</span>

<span class="k">def</span> <span class="nf">principal_curve</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pca</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    input : numpy.array
    returns:
    Result::Object
        Methods:
        projections - the matrix of the projectiond
        ixsort - the order ot the points (as in argsort)
        arclength - the lenght of the arc from the beginning to the point
    </span><span class="sh">"""</span>
    <span class="c1"># convert array to R matrix
</span>    <span class="n">xr</span> <span class="o">=</span> <span class="nf">array_to_rmatrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">pca</span><span class="p">:</span>
        <span class="c1">#perform pca
</span>        <span class="n">t</span> <span class="o">=</span> <span class="n">robj</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="nf">prcomp</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
        <span class="c1">#determine dimensionality reduction
</span>        <span class="n">usedcomp</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span> <span class="nf">sum</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="sh">'</span><span class="s">sdev</span><span class="sh">'</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span> <span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">usedcomp</span> <span class="o">=</span> <span class="nf">min</span><span class="p">([</span><span class="n">usedcomp</span><span class="p">,</span> <span class="nf">sum</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="sh">'</span><span class="s">sdev</span><span class="sh">'</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">),</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">Xpc</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">)])[:,:</span><span class="n">usedcomp</span><span class="p">]</span>
        <span class="c1"># convert array to R matrix
</span>        <span class="n">xr</span> <span class="o">=</span> <span class="nf">array_to_rmatrix</span><span class="p">(</span><span class="n">Xpc</span><span class="p">)</span>

    <span class="c1">#import the correct namespace
</span>    <span class="n">princurve</span> <span class="o">=</span> <span class="nf">importr</span><span class="p">(</span><span class="sh">"</span><span class="s">princurve</span><span class="sh">"</span><span class="p">,</span><span class="n">on_conflict</span><span class="o">=</span><span class="sh">"</span><span class="s">warn</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1">#call the function
</span>    <span class="n">fit1</span> <span class="o">=</span> <span class="n">princurve</span><span class="p">.</span><span class="nf">principal_curve</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
    
    <span class="c1">#extract the outputs
</span>    <span class="k">class</span> <span class="nc">Results</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nc">Results</span><span class="p">()</span>
    <span class="n">results</span><span class="p">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span> <span class="n">fit1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">results</span><span class="p">.</span><span class="n">ixsort</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span> <span class="n">fit1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># R is 1 indexed
</span>    <span class="n">results</span><span class="p">.</span><span class="n">arclength</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span> <span class="n">fit1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">results</span><span class="p">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span> <span class="n">fit1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">pca</span><span class="p">:</span>
        <span class="n">results</span><span class="p">.</span><span class="n">PCs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span> <span class="c1">#only the used components
</span>        
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">import</span> <span class="n">igraph</span>
<span class="n">nn</span> <span class="o">=</span> <span class="nc">NearestNeighbors</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">nn</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pcs</span><span class="p">[:,:</span><span class="mi">4</span><span class="p">])</span>
<span class="n">knn_pca</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nf">kneighbors_graph</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">distance</span><span class="sh">'</span><span class="p">)</span>
<span class="n">knn_pca</span> <span class="o">=</span> <span class="n">knn_pca</span><span class="p">.</span><span class="nf">tocoo</span><span class="p">()</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">igraph</span><span class="p">.</span><span class="nc">Graph</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">knn_pca</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">knn_pca</span><span class="p">.</span><span class="n">col</span><span class="p">)),</span> <span class="n">directed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edge_attrs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">weight</span><span class="sh">'</span><span class="p">:</span> <span class="n">knn_pca</span><span class="p">.</span><span class="n">data</span><span class="p">})</span>
<span class="n">VxCl</span> <span class="o">=</span> <span class="n">G</span><span class="p">.</span><span class="nf">community_multilevel</span><span class="p">(</span><span class="n">return_levels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">VxCl</span><span class="p">.</span><span class="n">membership</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">numpy_groupies</span> <span class="kn">import</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">aggregate_np</span>

<span class="n">pc_obj</span> <span class="o">=</span> <span class="nf">principal_curve</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pcs</span><span class="p">[:,:</span><span class="mi">8</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">pc_obj</span><span class="p">.</span><span class="n">arclength</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">pc_obj</span><span class="p">.</span><span class="n">arclength</span><span class="p">)</span> <span class="o">-</span> <span class="n">pc_obj</span><span class="p">.</span><span class="n">arclength</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="nf">aggregate_np</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pc_obj</span><span class="p">.</span><span class="n">arclength</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">median</span><span class="p">)))[</span><span class="n">labels</span><span class="p">]</span>
<span class="n">manual_annotation</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">i</span><span class="p">):[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>
<span class="n">annotation_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">manual_annotation</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span> <span class="p">}</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">annotation_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
<span class="n">colors20</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">vstack</span><span class="p">((</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="nf">tab20b</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="nf">tab20c</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">set_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">cluster_colors_dict</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">colors20</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">20</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">manual_annotation</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
<span class="n">vlm</span><span class="p">.</span><span class="n">ca</span><span class="p">[</span><span class="sh">'</span><span class="s">Clusters</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/anaconda3/lib/python3.6/site-packages/rpy2/robjects/packages_utils.py:107: UserWarning: Conflict when converting R symbols in the package "princurve" to Python symbols: 
-lines_principal_curve -&gt; lines.principal_curve, lines.principal.curve
- plot_principal_curve -&gt; plot.principal_curve, plot.principal.curve
- points_principal_curve -&gt; points.principal_curve, points.principal.curve
  warn(msg)
</code></pre></div></div> <h1 id="knn-imputation-gamma-fitting-and-velocity-calculation">kNN Imputation, gamma fitting, and velocity calculation</h1> <p>This is really the heart of the velocyto tool, and it only takes up a couple of lines. Most of the RNA velocity pipelines are calculating velocity and then spending a lot of time figuring out what to do with it, whether that is clustering, ordering cells in pseudotime, predicting trajectories through the data, visualizing, etc. The actual calculation of velocity is pretty simple.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="o">=</span> <span class="mi">550</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">knn_imputation</span><span class="p">(</span><span class="n">n_pca_dims</span><span class="o">=</span><span class="n">n_comps</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">balanced</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">b_sight</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">vlm</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                   <span class="n">b_maxl</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">vlm</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/gamma_fit.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">normalize_median</span><span class="p">()</span> <span class="c1"># not strictly necessary
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">fit_gammas</span><span class="p">(</span><span class="n">maxmin_perc</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">95</span><span class="p">],</span> <span class="n">limit_gamma</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># fit gammas; because this step is so important, double 
#check the API to make sure you are using the correct settings for your specific dataset
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="sh">"</span><span class="s">imputed</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># not strictly necessary
</span><span class="n">vlm</span><span class="p">.</span><span class="n">Pcs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pcs</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># defining Pcs as a array based on the pcs attribute we calculated earlier
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">predict_U</span><span class="p">()</span> <span class="c1"># predict U (gamma * S) given the gamma model fit
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">calculate_velocity</span><span class="p">()</span> <span class="c1"># calculate velocity of each cell
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">calculate_shift</span><span class="p">()</span> <span class="c1"># Find the change (deltaS) in gene expression for every cell
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">extrapolate_cell_at_t</span><span class="p">(</span><span class="n">delta_t</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Extrapolate the gene expression profile for each cell after delta_t (arbitrary units)
</span></code></pre></div></div> <p>For whatever reason, the loom file started to not allow conversion to HDF5 file. Apparently the cluster labels are in the wrong format, as specified: https://github.com/velocyto-team/velocyto.py/issues/40</p> <p>The below line should fix this.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="o">=</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">string_</span><span class="p">)</span> <span class="c1">#not strictly necessary
</span><span class="n">vlm</span><span class="p">.</span><span class="nf">to_hdf5</span><span class="p">(</span><span class="sh">'</span><span class="s">vlm_tk01_example</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <h1 id="estimate-transition-probabilities-calculate-embedding-shift-and-calculate-velocity-field-averaged-grid-arrows">Estimate transition probabilities, calculate embedding shift, and calculate velocity field (averaged grid) arrows</h1> <div class="alert alert-block alert-warning"> <b>Warning:</b> Run below chunk OUTSIDE of the kernel! The jupyter notebook doesn't have the computational power to run the estimate_transition_prob command and it will kill the kernel. On my computer, I needed to specify os.environ['KMP_DUPLICATE_LIB_OK']='True' to get it to run without killing iPython. After running in iPython, save to an hdf5 file so we can reopen it in this notebook below. </div> <p>When estimating probability of transitioning to another cell, you must embed the velocity arrows into the manifold and thus must specify this by <code class="language-plaintext highlighter-rouge">embed</code>. The other settings are explained below.</p> <table> <tr> <td> <img src="/assets/img/rna-velocity/visualize_a.png" alt="Drawing" style="width: 500px;"> </td> <td> <img src="/assets/img/rna-velocity/visualize_b.png" alt="Drawing" style="width: 500px;"> </td> </tr> </table> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#########################################
#### Do not run in jupyter notebook #####
#########################################
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">loompy</span>
<span class="kn">import</span> <span class="n">velocyto</span> <span class="k">as</span> <span class="n">vcy</span>
<span class="n">vlm</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="nf">load_velocyto_hdf5</span><span class="p">(</span><span class="sh">'</span><span class="s">vlm_tk01_example</span><span class="sh">'</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">KMP_DUPLICATE_LIB_OK</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="sh">'</span><span class="s">True</span><span class="sh">'</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">estimate_transition_prob</span><span class="p">(</span><span class="n">hidim</span><span class="o">=</span><span class="sh">"</span><span class="s">Sx_sz</span><span class="sh">"</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="sh">"</span><span class="s">Pcs</span><span class="sh">"</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="sh">"</span><span class="s">log</span><span class="sh">"</span><span class="p">,</span> <span class="n">psc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">knn_random</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sampled_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">to_hdf5</span><span class="p">(</span><span class="sh">'</span><span class="s">vlm_tk01_example</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#########################################
</span></code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="nf">load_velocyto_hdf5</span><span class="p">(</span><span class="sh">'</span><span class="s">vlm_tk01_example</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">calculate_embedding_shift</span><span class="p">(</span><span class="n">sigma_corr</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">expression_scaling</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">vlm</span><span class="p">.</span><span class="nf">calculate_grid_arrows</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

</code></pre></div></div> <h1 id="plot-cells-with-velocity-embedded">Plot cells with velocity embedded</h1> <p>Because of the weird problem noted above that requires this line to fix: <code class="language-plaintext highlighter-rouge">vlm.cluster_labels=vlm.cluster_labels.astype(np.string_)</code> You may need to rerun the clustering of cells to get the cluster names in the right format (ints) that you can then iterate through to plot below.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">plot_grid_arrows</span><span class="p">(</span><span class="n">scatter_kwargs_dict</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">alpha</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.7</span><span class="p">,</span> <span class="sh">"</span><span class="s">lw</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.7</span><span class="p">,</span> <span class="sh">"</span><span class="s">edgecolor</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">0.4</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">s</span><span class="sh">"</span><span class="p">:</span><span class="mi">70</span><span class="p">,</span> <span class="sh">"</span><span class="s">rasterized</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span>
                     <span class="n">min_mass</span><span class="o">=</span><span class="mf">2.9</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="sh">'</span><span class="s">xy</span><span class="sh">'</span><span class="p">,</span> <span class="n">scale_units</span><span class="o">=</span><span class="sh">'</span><span class="s">xy</span><span class="sh">'</span><span class="p">,</span> <span class="c1">#plot_random=True,
</span>                     <span class="n">headaxislength</span><span class="o">=</span><span class="mf">2.75</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mf">4.8</span><span class="p">,</span> <span class="n">quiver_scale</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">scale_type</span><span class="o">=</span><span class="sh">"</span><span class="s">relative</span><span class="sh">"</span><span class="p">)</span>
<span class="c1">#plt.plot(pc_obj.projections[pc_obj.ixsort,0], pc_obj.projections[pc_obj.ixsort,1], c="w", lw=6, zorder=1000000)
#plt.plot(pc_obj.projections[pc_obj.ixsort,0], pc_obj.projections[pc_obj.ixsort,1], c="k", lw=3, zorder=2000000)
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">ca</span><span class="p">[</span><span class="sh">"</span><span class="s">Clusters</span><span class="sh">"</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">pc_m</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">median</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">pcs</span><span class="p">[[</span><span class="n">x</span> <span class="o">==</span> <span class="nf">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">],</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="n">pc_m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pc_m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nf">str</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">[[</span><span class="n">x</span> <span class="o">==</span> <span class="nf">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">]][</span><span class="mi">0</span><span class="p">]),</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">facecolor</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">alpha</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.6</span><span class="p">})</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">equal</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># plt.savefig('grid_arrows_velfield.pdf')
</span></code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-6.179891076443215,
 15.366726792232903,
 -12.449288968577802,
 10.019450217263424)
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_33_1.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h2 id="specific-genes-expressed-throughout-pca-plot">Specific genes expressed throughout PCA plot</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plotting utility functions
</span><span class="k">def</span> <span class="nf">despline</span><span class="p">():</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">()</span>
    <span class="c1"># Hide the right and top spines
</span>    <span class="n">ax1</span><span class="p">.</span><span class="n">spines</span><span class="p">[</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">].</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">.</span><span class="n">spines</span><span class="p">[</span><span class="sh">'</span><span class="s">top</span><span class="sh">'</span><span class="p">].</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Only show ticks on the left and bottom spines
</span>    <span class="n">ax1</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_ticks_position</span><span class="p">(</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_ticks_position</span><span class="p">(</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">minimal_xticks</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">end_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">around</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="nf">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log10</span><span class="p">(</span><span class="n">end</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xlims</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">xlims_tx</span> <span class="o">=</span> <span class="p">[</span><span class="sh">""</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
    <span class="n">xlims_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlims_tx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">xlims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">xlims</span><span class="p">,</span> <span class="n">xlims_tx</span><span class="p">)</span>

    
<span class="k">def</span> <span class="nf">minimal_yticks</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">end_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">around</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="nf">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log10</span><span class="p">(</span><span class="n">end</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end_</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ylims_tx</span> <span class="o">=</span> <span class="p">[</span><span class="sh">""</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span>
    <span class="n">ylims_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylims_tx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">ylims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">02</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ylims_tx</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mf">2.8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gn</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">([</span><span class="sh">"</span><span class="s">Calca</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">Ascl1</span><span class="sh">'</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ix</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">ra</span><span class="p">[</span><span class="sh">"</span><span class="s">Gene</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">gn</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">vcy</span><span class="p">.</span><span class="nf">scatter_viz</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">Sx_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">Ux_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:],</span> <span class="n">c</span><span class="o">=</span><span class="n">vlm</span><span class="p">.</span><span class="n">colorandum</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="n">gn</span><span class="p">)</span>
    <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">vlm</span><span class="p">.</span><span class="n">Sx</span><span class="p">[</span><span class="n">ix</span><span class="p">,:].</span><span class="nf">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="n">vlm</span><span class="p">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">*</span> <span class="n">xnew</span> <span class="o">+</span> <span class="n">vlm</span><span class="p">.</span><span class="n">q</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">Ux_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:])</span><span class="o">*</span><span class="mf">1.02</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">Sx_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:])</span><span class="o">*</span><span class="mf">1.02</span><span class="p">)</span>
    <span class="nf">minimal_yticks</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">Ux_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:])</span><span class="o">*</span><span class="mf">1.02</span><span class="p">)</span>
    <span class="nf">minimal_xticks</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">Sx_sz</span><span class="p">[</span><span class="n">ix</span><span class="p">,:])</span><span class="o">*</span><span class="mf">1.02</span><span class="p">)</span>
    <span class="nf">despline</span><span class="p">()</span>
    
    <span class="n">vlm</span><span class="p">.</span><span class="nf">plot_velocity_as_color</span><span class="p">(</span><span class="n">gene_name</span><span class="o">=</span><span class="n">gn</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">which_tsne</span><span class="o">=</span><span class="sh">'</span><span class="s">pcs</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">vlm</span><span class="p">.</span><span class="nf">plot_expression_as_color</span><span class="p">(</span><span class="n">gene_name</span><span class="o">=</span><span class="n">gn</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">which_tsne</span><span class="o">=</span><span class="sh">'</span><span class="s">pcs</span><span class="sh">'</span><span class="p">)</span>
    
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_36_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h2 id="velocity-by-igraph-cluster">Velocity by igraph cluster</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">ca</span><span class="p">[</span><span class="sh">"</span><span class="s">Clusters</span><span class="sh">"</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">quiver_scale</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="nf">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">treat_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
<span class="c1">#     treat_index = np.where(vlm.ca['Clusters'] == str(t))[0]
</span>    <span class="n">treat_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">treat_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">treat_index</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">xx-large</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>
    
    <span class="n">ix_choice</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1.</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">quiver_kwargs</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.00045</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">vlm</span><span class="p">.</span><span class="n">colorandum</span><span class="p">[</span><span class="n">treat_index</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">quiver</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">treat_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">treat_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
           <span class="n">vlm</span><span class="p">.</span><span class="n">delta_embedding</span><span class="p">[</span><span class="n">treat_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">delta_embedding</span><span class="p">[</span><span class="n">treat_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
           <span class="n">scale</span><span class="o">=</span><span class="n">quiver_scale</span><span class="p">,</span> <span class="o">**</span><span class="n">quiver_kwargs</span><span class="p">)</span>
    

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="c1"># plt.savefig('figures/arrows_by_igraph_cluster.pdf')
</span></code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_38_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h1 id="markov-chain-run-forward-and-backwards">Markov Chain (run forward and backwards)</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">steps</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">grs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dim_i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[:,</span> <span class="n">dim_i</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[:,</span> <span class="n">dim_i</span><span class="p">])</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">gr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">dim_i</span><span class="p">])</span>
    <span class="n">grs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>

<span class="n">meshes_tuple</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">grs</span><span class="p">)</span>
<span class="n">gridpoints_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">vstack</span><span class="p">([</span><span class="n">i</span><span class="p">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">meshes_tuple</span><span class="p">]).</span><span class="n">T</span>

<span class="kn">from</span> <span class="n">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="n">nn</span> <span class="o">=</span> <span class="nc">NearestNeighbors</span><span class="p">()</span>
<span class="n">nn</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">)</span>
<span class="n">dist</span><span class="p">,</span> <span class="n">ixs</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nf">kneighbors</span><span class="p">(</span><span class="n">gridpoints_coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">diag_step_dist</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">((</span><span class="n">meshes_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">meshes_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">meshes_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">meshes_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">min_dist</span> <span class="o">=</span> <span class="n">diag_step_dist</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">]</span>
<span class="n">gridpoints_coordinates</span> <span class="o">=</span> <span class="n">gridpoints_coordinates</span><span class="p">[</span><span class="n">dist</span><span class="p">.</span><span class="n">flat</span><span class="p">[:]</span><span class="o">&lt;</span><span class="n">min_dist</span><span class="p">,:]</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">]</span>

<span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vlm</span><span class="p">.</span><span class="nf">prepare_markov</span><span class="p">(</span><span class="n">sigma_D</span><span class="o">=</span><span class="n">diag_step_dist</span><span class="p">,</span> <span class="n">sigma_W</span><span class="o">=</span><span class="n">diag_step_dist</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="sh">'</span><span class="s">backwards</span><span class="sh">'</span><span class="p">,</span> <span class="n">cells_ixs</span><span class="o">=</span><span class="n">ixs</span><span class="p">)</span>
<span class="n">vlm</span><span class="p">.</span><span class="nf">run_markov</span><span class="p">(</span><span class="n">starting_p</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)),</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">2500</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">diffused_n</span> <span class="o">=</span> <span class="n">vlm</span><span class="p">.</span><span class="n">diffused</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">diffused_n</span> <span class="o">/=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">diffused_n</span><span class="p">,</span> <span class="mi">97</span><span class="p">)</span>
<span class="n">diffused_n</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">diffused_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="nf">scatter_viz</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">diffused_n</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">viridis_r</span><span class="sh">"</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">"</span><span class="s">figures/startpoint_distr.pdf</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_42_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h2 id="trajectories-of-mcmc">Trajectories of MCMC</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cluster_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="n">indices_pick</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">ixs</span><span class="p">).</span><span class="nf">intersection</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span>
    <span class="n">st_ind</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">indices_pick</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>  <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ixs</span> <span class="o">==</span> <span class="n">st_ind</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]:</span>
        <span class="n">s</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#run MCMC from cluster 1
</span><span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">vlm_embed</span><span class="p">[</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">c</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">vlm</span><span class="p">.</span><span class="nf">prepare_markov</span><span class="p">(</span><span class="n">sigma_D</span><span class="o">=</span><span class="n">diag_step_dist</span><span class="p">,</span> <span class="n">sigma_W</span><span class="o">=</span><span class="n">diag_step_dist</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="sh">'</span><span class="s">forward</span><span class="sh">'</span><span class="p">,</span> <span class="n">cells_ixs</span><span class="o">=</span><span class="n">ixs</span><span class="p">)</span>
<span class="c1"># vlm.run_markov(n_steps=2500, mode = 'trajectory')
</span><span class="n">start</span> <span class="o">=</span> <span class="nf">cluster_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="c1"># start = np.ones(len(ixs))/len(ixs)
</span><span class="n">diffusor</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="n">diffusion</span><span class="p">.</span><span class="nc">Diffusion</span><span class="p">()</span>
<span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span> <span class="o">=</span> <span class="n">diffusor</span><span class="p">.</span><span class="nf">diffuse</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">vlm</span><span class="p">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">trajectory</span><span class="sh">'</span><span class="p">)</span>


<span class="n">visits</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ixs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">set</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">)]</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">visits</span><span class="p">)):</span>
    <span class="n">col</span><span class="p">[</span><span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">viridis_r</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="p">.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">1</span><span class="p">],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">1</span><span class="p">],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">H</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>


</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.colorbar.Colorbar at 0x142581240&gt;
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_47_1.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <h2 id="run-multiple-mcmc-walks-to-get-a-sense-of-where-each-cluster-goes">Run multiple MCMC walks to get a sense of where each cluster goes</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">random_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">specific_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">st_ind</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>  <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ixs</span> <span class="o">==</span> <span class="n">st_ind</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]:</span>
        <span class="n">s</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">ss</span> <span class="o">=</span> <span class="nf">specific_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">ss</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([0, 0, 0, ..., 0, 0, 0])
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="k">def</span> <span class="nf">get_trajectory</span><span class="p">(</span><span class="n">vlm</span><span class="p">,</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="n">start_p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">))</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">),</span> <span class="n">iters</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">)</span>
    <span class="n">col_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">)</span>

    <span class="n">diffusor</span> <span class="o">=</span> <span class="n">vcy</span><span class="p">.</span><span class="n">diffusion</span><span class="p">.</span><span class="nc">Diffusion</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span> <span class="o">=</span> <span class="n">diffusor</span><span class="p">.</span><span class="nf">diffuse</span><span class="p">(</span><span class="n">start_p</span><span class="p">,</span> <span class="n">vlm</span><span class="p">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">trajectory</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">visits</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ixs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">set</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">diffused_traj</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">visits</span><span class="p">)):</span>
            <span class="n">col</span><span class="p">[</span><span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">col_count</span><span class="p">[</span><span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">visits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">col_count</span>
<span class="n">col_count_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># for each point in a certain cluster, run the simulation multiple times. grab the indices of nonzeroes in col and check
# which clusters they are in. plot a barplot of % of time you get to each cluster
</span><span class="k">for</span> <span class="n">clust</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">7</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">8</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">9</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">10</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">)</span>
    <span class="c1">#Need to get indices of points in chosen cluster that are ALSO in ixs list
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">clust</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">ixs</span><span class="p">).</span><span class="nf">intersection</span><span class="p">(</span><span class="nf">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">clust</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]))):</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="nf">specific_start</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">total</span>
        <span class="n">col_count</span> <span class="o">=</span> <span class="nf">get_trajectory</span><span class="p">(</span><span class="n">vlm</span><span class="p">,</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">start_p</span> <span class="o">=</span> <span class="n">ss</span><span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">col_count</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)]</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">vlm</span><span class="p">.</span><span class="n">embedding</span><span class="p">[</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">viridis_r</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting in Cluster </span><span class="sh">"</span><span class="o">+</span><span class="n">clust</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Cluster</span><span class="si">{</span><span class="n">clust</span><span class="si">}</span><span class="s">_distr_visited.pdf</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="n">col_count_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>




</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_1.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_3.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_5.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_7.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_9.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_11.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_13.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>7
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_15.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>8
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_17.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_19.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_51_21.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <p>col_count_list is a list of the total number of visits to each datapoint starting in each cluster (list len 11 of arrays with length 4514)</p> <p>For each array in the list (\(0&lt;i&lt;10\)), check the sum of visits within i versus not i and compare.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="n">leaving</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">11</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">)),</span> <span class="n">index</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">leaving</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">():</span>
    <span class="n">start_clust</span> <span class="o">=</span> <span class="n">col_count_list</span><span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">clust</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">7</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">8</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">9</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">10</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">clust</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">start_clust</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">clust</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">leaving</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">7</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">8</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">9</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">10</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting in Cluster </span><span class="sh">"</span><span class="o">+</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of Visits to Cluster</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">([</span><span class="sh">"</span><span class="s">Stay</span><span class="sh">"</span><span class="p">,</span><span class="sh">'</span><span class="s">Leave</span><span class="sh">'</span><span class="p">],</span> <span class="p">[</span><span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:].</span><span class="nf">sum</span><span class="p">(),</span> <span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">leaving</span><span class="p">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="n">i</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span><span class="o">/</span><span class="n">leaving</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:].</span><span class="nf">sum</span><span class="p">()])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">axes</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(</span><span class="mf">0.466059</span><span class="p">,</span><span class="n">ls</span> <span class="o">=</span> <span class="sh">"</span><span class="s">--</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">prob_leaving_start_in_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">.pdf</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_0.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_1.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_2.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_3.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_4.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_5.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_6.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_7.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_8.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_9.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="img"> <img src="/assets/img/rna-velocity/output_53_10.png" style="height: 100%; width: 100%; object-fit: contain"> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># probability of ending in each cluster
</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">7</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">8</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">9</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">10</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">lengths</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">vlm</span><span class="p">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]))</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">leaving</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">leaving</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">lengths</span><span class="o">/</span><span class="nf">max</span><span class="p">(</span><span class="n">leaving</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">lengths</span><span class="p">),</span>  <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">7</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">8</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">9</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">10</span><span class="sh">'</span><span class="p">])</span>



</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x13718cdd8&gt;
</code></pre></div></div> <div class="img"> <img src="/assets/img/rna-velocity/output_54_1.png" style="height: 100%; width: 100%; object-fit: contain"> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2026 Sarah M. Groves. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>